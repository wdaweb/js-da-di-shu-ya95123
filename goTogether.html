<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>天堂見 We will see in Heaven</title>
  <!-- css reset -->
  <link rel="stylesheet" href="/css/reset.css">
  <!-- 連結 css 樣式 -->
  <link rel="stylesheet" href="/css/goTogether.css">
</head>

<body>
  <!-- TODO 5初始圖片、4背景音效、2CSS圖片動畫、1本機Rank、6alert樣式、3Stop鍵 -->
  <div id="top">
    <p id="text-timeleft">30 s</p>
    <p id="text-score">Score：0 分</p>
    <div id="picExframe">
      <table>
        <tr>
          <td class="exLeft" rowspan="2"><img class="picEx" src="/images/fish.png" alt="fish">
          </td>
          <td class="exCalc red">+1分</td>
          <td class="exLeft" rowspan="2"><img class="picEx" src="/images/sad-people.png" alt="sad-people">
          </td>
          <td class="exCalc red">+3分</td>
          <td class="exLeft" rowspan="2"><img class="picEx" src="/images/sushi.png" alt="sushi"></td>
          <td class="exCalc red">+0分</td>
          <td class="exLeft" rowspan="2"><img class="picEx" src="/images/egg.png" alt="egg"></td>
          <td class="exCalc red">+5分</td>
          <td class="exLeft" rowspan="2"><img class="picEx" src="/images/red-evil.png" alt="red-evil"></td>
          <td class="exCalc">-1分</td>
          <td class="exLeft" rowspan="2"><img class="picEx" src="/images/yellow-evil.png" alt="yellow-evil">
          </td>
          <td class="exCalc">-2分</td>
        </tr>
        <tr>
          <td class="exCalc red">+1秒</td>
          <td class="exCalc red">+0秒</td>
          <td class="exCalc red">+2秒</td>
          <td class="exCalc red">+0秒</td>
          <td class="exCalc">-0秒</td>
          <td class="exCalc">-1秒</td>
        </tr>
      </table>
    </div>
    <!-- <div id="picExframe">
            <div><img class="picEx" src="/images/fish.png" alt="fish"></div>
            <div><img class="picEx" src="/images/sad-people.png" alt="sad-people"></div>
            <div><img class="picEx" src="/images/sushi.png" alt="sushi"></div>
            <div><img class="picEx" src="/images/egg.png" alt="egg"></div>
            <div><img class="picEx" src="/images/red-evil.png" alt="red-evil"></div>
            <div><img class="picEx" src="/images/yellow-evil.png" alt="yellow-evil"></div>
        </div> -->
  </div>

  <div id="left">
    <p class="sideP">排行榜</p>
    <div>
      <span class="text-ranknum">1</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>
    <div>
      <span class="text-ranknum">2</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>
    <div>
      <span class="text-ranknum">3</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>
    <div>
      <span class="text-ranknum">4</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>
    <div>
      <span class="text-ranknum">5</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>
    <div>
      <span class="text-ranknum">6</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>
    <div>
      <span class="text-ranknum">7</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>
    <div>
      <span class="text-ranknum">8</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>
    <div>
      <span class="text-ranknum">9</span>&ensp;
      <span class="text-rankplayer">nobody</span>
      <span class="text-rankscore">0</span>
    </div>

  </div>

  <div id="right">
    <p class="sideP">工具</p>
  </div>

  <div id="middle">
    <table id="gameFrame" border="1">
      <tr>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
      </tr>
      <tr>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
      </tr>
      <tr>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
      </tr>
      <tr>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
      </tr>
      <tr>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
        <td><img src="" alt="" class="hole"></td>
      </tr>
    </table>
  </div>

  <div id="btn-start">Go</div>

  <script>
    // top 剩餘時間、當前分數
    const textTime = document.getElementById("text-timeleft");
    const textScore = document.getElementById("text-score");

    // middle 遊戲畫面、地洞
    const gameFrame = document.getElementById("gameFrame");
    const holes = document.getElementsByClassName("hole");
    const btnStart = document.getElementById("btn-start");

    // left
    // const textRankNum = document.getElementsByClassName("text-ranknum");
    const textRankPlayer = document.getElementsByClassName("text-rankplayer");
    const textRankScore = document.getElementsByClassName("text-rankscore");

    // 隨機數 function
    const rand = (min, max) => {
      return Math.round(Math.random() * (max - min) + min);
    }

    // 圖片插入區
    let imgFish = "/images/fish.png";
    let imgSad = "/images/sad-people.png";
    let imgSushi = "/images/sushi.png";
    let imgEgg = "/images/egg.png";
    let imgRedEvil = "/images/red-evil.png";
    let imgYellowEvil = "/images/yellow-evil.png";
    // 圖片出現產生不同機率用
    let imgp = 0;
    // const imgs = [imgFish, imgSad, imgSushi, imgEgg, imgRedEvil, imgYellowEvil];

    // 遊戲變數基本設定區
    let score = 0;
    let inGame = false;
    let timeLeft = 30;
    let timer = 0;
    let gameRound = 0;
    let randJump = 0;
    let jumps = [];
    let rankScore = [{ name: '', score: 0 }, { name: '', score: 0 }, { name: '', score: 0 }, { name: '', score: 0 }, { name: '', score: 0 }, { name: '', score: 0 }, { name: '', score: 0 }, { name: '', score: 0 }, { name: '', score: 0 }];
    // let storage = "";
    let storage = JSON.parse(localStorage.getItem("rankScore1"));
    // TODO 要再設定 rank 的分數比較
    if (storage != null) {
      // 將最高分的"名字"儲存，並修改網頁文字
      rankScore[0].name = storage.name;
      textRankPlayer[0].innerText = rankScore[0].name;
      // 將最高分的"分數"儲存，並修改網頁文字
      rankScore[0].score = storage.score;
      textRankScore[0].innerText = rankScore[0].score;
    }

    // 點擊"開始"
    btnStart.onclick = () => {
      // 讓btnStart 消失
      btnStart.style.display = "none";
      // 開始遊戲
      inGame = true;
      // 重置分數、起始時間
      score = 0;
      textScore.innerText = `Score：${score} 分`;
      timeLeft = 3;
      textTime.innerText = `${timeLeft} s`;

      timer = setInterval(timeDes, 1000);
      gameRound = setInterval(game, 2500);
      game();
    }

    // 時間線控制
    const timeDes = () => {
      // 遞減時間
      timeLeft--;
      textTime.innerText = `${timeLeft} s`;

      // 遊戲結束時
      if (timeLeft <= 0) {
        inGame = false;
        clearInterval(timer);
        clearInterval(gameRound);
        // 清空圖片
        for (let hole of holes) {
          hole.src = "";
        }

        // setTimeout 為了讓秒數跑到 0s
        setTimeout(() => {
          // TODO 把alert設定改好看 用div跳
          alert(`你獲得了 ${score} 分`);

          // TODO 進入排行榜(分數大於第9名才會進榜，同分不會進)
          if (storage == null || score > rankScore[8].score) {
            let input = prompt("太棒了 ～ 恭喜你進入前 Top 9 ！🎏\n請寫下你的名字，因你是大能的勇者 🤴👸");
            if (input != null && input.trim() !== '') {
              // input = prompt("尊貴的勇者請留下你尊貴的大名，好讓我們可以為你慶祝👼");
              rankScore[0].name = input;
              rankScore[0].score = score;
              textRankPlayer[0].innerText = rankScore[0].name;
              textRankScore[0].innerText = rankScore[0].score;
              localStorage.setItem(`rankScore1`, JSON.stringify(rankScore[0]));

            }

            // re
            //超越哪一名就把名字、分數蓋過去
            // for (let i = 8; i <= 0; i--) {
            //   if (score > rankScore[i].score && score < rankScore[i + 1].score) {
            //     // !先把低於分數的人Rank往後擠
            //     for (let j = i; j <= 7; j++) {
            //       // 後一名排位 = 原排位的值
            //       rankScore[j + 1].name = rankScore[j].name;
            //       rankScore[j + 1].score = rankScore[j].score;
            //       textRankPlayer[j + 1].innerText = rankScore[j].name;
            //       textRankScore[j + 1].innerText = rankScore[j].score;
            //       localStorage.setItem(`rankScore${j + 1}`, JSON.stringify(rankScore[j + 1]));

            //       storage = JSON.parse(localStorage.getItem(`rankScore${j + 1}`));
            //     }

            //     // 上榜人的資料
            //     rankScore[i].name = input;
            //     rankScore[i].score = score;
            //     // 修改網頁上文字
            //     textRankPlayer[i].innerText = input;
            //     textRankScore[i].innerText = score;
            //     localStorage.setItem(`rankScore${i}`, JSON.stringify(rankScore[i]));

            //     storage = JSON.parse(localStorage.getItem(`rankScore${i}`));
            //     console.log(storage);
            //   }
            //   // 同分狀態(因為是遞增狀態，就算很多同分，也在同分最後)
            //   else if (score == rankScore[i].score) {
            //     for (let k = i + 1; k <= 7; k++) {
            //       // 後兩名排位 = 原後一名的值
            //       rankScore[k + 1].name = rankScore[k].name;
            //       rankScore[k + 1].score = rankScore[k].score;
            //       textRankPlayer[k + 1].innerText = rankScore[k].name;
            //       textRankScore[k + 1].innerText = rankScore[k].score;
            //       localStorage.setItem(`rankScore${k + 1}`, JSON.stringify(rankScore[k + 1]));

            //       storage = JSON.parse(localStorage.getItem(`rankScore${k + 1}`));
            //     }

            //     // 上榜人的資料 (後一名排位 = 當前 input 值)
            //     rankScore[i + 1].name = input;
            //     rankScore[i + 1].score = score;
            //     // 修改網頁上文字
            //     textRankPlayer[i + 1].innerText = rankScore[i + 1].name;
            //     textRankScore[i + 1].innerText = rankScore[i + 1].score;
            //     localStorage.setItem(`rankScore${i + 1}`, JSON.stringify(rankScore[i + 1]));

            //     storage = JSON.parse(localStorage.getItem(`rankScore${i + 1}`));
            //     console.log(storage);
            //   }
            // }
            //------re 

            // 暴力條件解
            // if (score > rankScore[8].score && score < rankScore[7].score) {
            //     rankScore[8].name = input;
            //     rankScore[8].score = score;
            //     // 修改網頁上文字
            //     textRankPlayer[8].innerText = rankScore[8].name;
            //     textRankScore[8].innerText = rankScore[8].score;
            // }
            // else if (score > rankScore[7].score && score < rankScore[6].score) {
            //     rankScore[7].name = input;
            //     rankScore[7].score = score;
            //     // 修改網頁上文字
            //     textRankPlayer[7].innerText = rankScore[7].name;
            //     textRankScore[7].innerText = rankScore[7].score;
            // }
          }
          else if (score == rankScore[8].score) {
            alert("尊貴的勇士，你雖與第9名同分，但尚還不能進榜，請繼續堅持呀 ~ 突破自己💪");
          }


          // 讓 btn 出現，原本css設flex，所以這裡也要調回flex，不然會跑版
          btnStart.style.display = "flex";

          // 讓剩餘時間調回來
          timeLeft = 30;
          textTime.innerText = `${timeLeft} s`;

          // TODO 回到初始圖片 (html也要加初始圖片gif or svg)
        }, 80)
      }
    }

    // 遊戲進行
    const game = () => {
      // 清空 hole 圖片
      for (let hole of holes) {
        hole.src = "";
      }
      // 重置 jumps隨機格子陣列、imgp圖片機率
      jumps = [];
      imgp = 0;

      // 隨機選7格跳圖片
      for (let i = 0; i < 7; i++) {
        // 隨機不重複
        randJump = rand(0, 34);
        while (jumps.includes(randJump)) {
          randJump = rand(0, 34);
        }
        jumps.push(randJump);

        // 已被選的隨機格子，再隨機選圖片跳出
        imgp = rand(1, 100);
        // console.log(imgp);
        if (imgp > 0 && imgp <= 30) {
          // 魚 30%
          holes[jumps[i]].src = imgFish;
        }
        else if (imgp > 30 && imgp <= 60) {
          // 難過 30%
          holes[jumps[i]].src = imgSad;
        }
        else if (imgp > 60 && imgp <= 67) {
          // 壽司 7%
          holes[jumps[i]].src = imgSushi;
        }
        else if (imgp > 67 && imgp <= 70) {
          // 彩蛋 3%
          holes[jumps[i]].src = imgEgg;
        }
        else if (imgp > 70 && imgp <= 85) {
          // 紅惡 15%
          holes[jumps[i]].src = imgRedEvil;
        }
        else if (imgp > 85 && imgp <= 100) {
          // 黃惡 15%
          holes[jumps[i]].src = imgYellowEvil;
        }
      }
    }

    // 遊戲點擊事件&分數、時間
    // TODO 被點擊時換圖片、音效
    for (let hole of holes) {
      hole.onclick = () => {
        // 魚 +1分 +1秒
        if (inGame && hole.src.includes(imgFish)) {
          // console.log(hole.src);
          hole.src = "/images/translate/fish-love.png"
          score++;
          textScore.innerText = `Score：${score} 分`;
          timeLeft++;
          textTime.innerText = `${timeLeft} s`;
        }
        // 難過 +3分
        else if (inGame && hole.src.includes(imgSad)) {
          hole.src = "/images/translate/love-people.png"
          score += 3;
          textScore.innerText = `Score：${score} 分`;
        }
        // 壽司 +2秒
        else if (inGame && hole.src.includes(imgSushi)) {
          hole.src = "/images/translate/sushi-eatten.png"
          timeLeft += 2;
          textTime.innerText = `${timeLeft} s`;
        }
        // 彩蛋 +5分
        else if (inGame && hole.src.includes(imgEgg)) {
          hole.src = "/images/translate/egg-love.png"
          score += 5;
          textScore.innerText = `Score：${score} 分`;
        }
        // 紅惡 -1分
        else if (inGame && hole.src.includes(imgRedEvil)) {
          // TODO 網子變大的動畫、設定秒數、還原
          hole.src = "/images/translate/net.png"
          score--;
          textScore.innerText = `Score：${score} 分`;
        }
        // 黃惡 -2分 -1秒
        else if (inGame && hole.src.includes(imgYellowEvil)) {
          hole.src = "/images/translate/yellow-evil-black-love.png"
          score -= 2;
          textScore.innerText = `Score：${score} 分`;
          timeLeft--;
          textTime.innerText = `${timeLeft} s`;
        }
      }
    }
    console.log(storage);
        // TODO 遊戲中鍵盤可以使用 ｓ 當作滑鼠點擊
        // document.onkeydown = (event) => {
        //     const key = event.key;
        //     if (key == "s") {
        //         const screen = document.getElementsByTagName("body");
        //         screen.onmousedown();
        //     }
        // }
  </script>

</body>

</html>